<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'self' 'nonce-<%= nonce %>' https://cdnjs.cloudflare.com 'unsafe-inline'; style-src 'self' https://fonts.googleapis.com https://cdnjs.cloudflare.com 'unsafe-inline'; font-src 'self' https://fonts.gstatic.com; connect-src 'self' http://localhost:8000 https://example.com;">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">
    <link rel="stylesheet" href="assets/css/style_common.css">
    <link rel="stylesheet" href="assets/css/style_register.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
</head>

<body>
    <div class="wrapper">
        <header class="container">
            <span class="logo">IT-ОФФЕР</span>
            <script nonce="<%= nonce %>">
                console.log('Hello, world!');
            </script>
            <nav>
                <ul>
                    <li><a href="index.html">Главная</a></li>
                    <li><a href="vacancies.html">Вакансии</a></li>
                    <li><a href="profile.html">Профиль</a></li>
                    <li>
                        <button id="toggleButton">Контакты</button>
                        <div id="dropdown" class="dropdown-content">
                            <ul class="dropdown-list">
                                <li><a href="tel:+79991234567">+7 (999) 123-45-67</a></li>
                                <li><a href="mailto:info@example.com">info@example.com</a></li>
                                <li><a href="https://t.me/example">Telegram</a></li>
                                <li><a href="https://wa.me/79991234567">WhatsApp</a></li>
                            </ul>
                        </div>
                    </li>
                    <script src="scripts/script.js" nonce="<%= nonce %>"></script>
                </ul>
            </nav>
            <h3>Регистрация</h3>
        </header>
        <main>
            <section class="form-section">
                <form action="/register" method="post" id="registrationForm">
                    <label for="role">Выберите роль:</label>
                    <select id="role" name="user_type" required>
                        <option value="notSelected">---------</option>
                        <option value="candidate">Соискатель</option>
                        <option value="employer">Работодатель</option>
                    </select>

                    <!-- Общие поля -->
                    <div id="commonFields" class="disabled">
                        <label for="name">Имя:</label>
                        <input type="text" id="name" name="first_name" required disabled>

                        <label for="surname">Фамилия:</label>
                        <input type="text" id="surname" name="last_name" required disabled>

                        <label for="email">Email:</label>
                        <input type="email" id="email" name="email" required disabled placeholder="example@rtxty.com">

                        <label for="phone">Номер телефона:</label>
                        <input type="tel" id="phone" name="phone_num" pattern="[0-9]{11}" required disabled
                            placeholder="8__________">

                        <label for="password">Пароль:</label>
                        <input type="password" id="password" name="password" required disabled
                            placeholder="Должен состоять минимум из 8 символов">

                        <label for="confirm-password">Подтверждение пароля:</label>
                        <input type="password" id="confirm-password" name="confirm-password" required disabled>
                    </div>

                    <!-- Поля для кандидата -->
                    <div id="candidateFields" style="display: none;">
                        <label for="tgId">Telegram ID:</label>
                        <input type="text" id="telegram_id" name="telegram_id">

                        <label for="education">Образование:</label>
                        <select id="education" name="education" required>
                            <option value="none">Без образования</option>
                            <option value="secondary">Среднее-профессиональное</option>
                            <option value="higher">Высшее</option>
                        </select>

                        <label for="experience">Опыт работы:</label>
                        <textarea id="experience" name="experience"></textarea>

                        <label for="skills">Ключевые навыки:</label>
                        <div class="checkbox-list" id="checkboxList">
                            <% skills.forEach(function(skill) { %>
                                <label>
                                    <input type="checkbox" name="skills[]" value="<%= skill.skill_id %>">
                                    <%= skill.skill_name %>
                                </label><br>
                            <% }); %>
                        </div>
                        
                        <label for="projects">Описание проектов:</label>
                        <textarea id="project_description_candidate" name="project_description_candidate"></textarea>

                        <label for="projectLinks">Ссылки на проекты:</label>
                        <input type="text" id="portfolio_links" name="portfolio_links">
                    </div>

                    <!-- Поля для работодателя -->
                    <div id="employerFields" style="display: none;">
                        <label for="companyName">Название компании:</label>
                        <input type="text" id="company_name" name="company_name">

                        <label for="companyDescription">Описание деятельности:</label>
                        <textarea id="description" name="description"></textarea>

                        <label for="legalAddress">Юридический адрес:</label>
                        <input type="text" id="legal_address" name="legal_address">

                        <label for="companyProjects">Описание проектов:</label>
                        <textarea id="project_description" name="project_description"></textarea>

                        <label for="projectPhotos">Фото проектов:</label>
                        <input type="file" id="project_photo" name="project_photo" multiple>

                        <label for="companyLogo">Логотип компании:</label>
                        <input type="file" id="company_logo" name="company_logo">

                        <label for="companyWebsite">Сайт компании:</label>
                        <input type="url" id="website" name="website">
                    </div>
                    <button type="submit">Зарегистрироваться</button>

                </form>
                <p>Уже есть аккаунт? <a href="login.html">Войти</a></p>
            </section>
        </main>
    </div>
    <footer>
        <div class="blocks container">
            <div>
                <span class="logo">IT-ОФФЕР</span>
                <p>Lorem Ipsum is simply dummy text of the printing and typesetting industry.</p>
            </div>
            <div>
                <h4>Contact us</h4>
                <p>Это ejs</p>
                <p>Lorem Ipsum is simply dummy text of the printing and typesetting industry.</p>
                <p>+908 89097 890</p>
            </div>
        </div>
        <hr>
        <p>Copyright ® 2021 Lorem All rights Rcerved</p>
    </footer>
    <script nonce="<%= nonce %>">
        document.getElementById('role').addEventListener('change', function () {
            var candidateFields = document.getElementById('candidateFields');
            var employerFields = document.getElementById('employerFields');
            if (this.value === 'notSelected') {
                candidateFields.style.display = 'none';
                employerFields.style.display = 'none';
            } else if (this.value === 'candidate') {
                candidateFields.style.display = 'block';
                employerFields.style.display = 'none';
            } else if (this.value === 'employer') {
                candidateFields.style.display = 'none';
                employerFields.style.display = 'block';
            }
        });
    </script>
    <!-- это скрипт для того чтобы до выбора роли была закрыта возможность ввода информации в поля фио почта номер телефона и тд (общие поля) -->
    <script nonce="<%= nonce %>">
        document.addEventListener('DOMContentLoaded', function () {
            const roleSelect = document.getElementById('role');
            const commonFields = document.getElementById('commonFields');
            const candidateFields = document.getElementById('candidateFields');
            const employerFields = document.getElementById('employerFields');

            roleSelect.addEventListener('change', function () {
                if (roleSelect.value === 'notSelected') {
                    commonFields.classList.add('disabled');
                    commonFields.querySelectorAll('input, textarea').forEach(input => input.disabled = true);
                    candidateFields.style.display = 'none';
                    employerFields.style.display = 'none';
                } else {
                    commonFields.classList.remove('disabled');
                    commonFields.querySelectorAll('input, textarea').forEach(input => input.disabled = false);

                    if (roleSelect.value === 'candidate') {
                        candidateFields.style.display = 'block';
                        employerFields.style.display = 'none';
                    } else if (roleSelect.value === 'employer') {
                        candidateFields.style.display = 'none';
                        employerFields.style.display = 'block';
                    }
                }
            });

            // Инициализация Select2 для ключевых навыков
            /*$('#skills').select2({
                placeholder: 'Выберите ключевые навыки',
                allowClear: true,
                width: '100%',
                templateResult: function (data, container) {
                    if (data.element) {
                        return $('<span><input type="checkbox" checked="checked" /> ' + data.text + '</span>');
                    }
                    return data.text;
                },
                escapeMarkup: function (markup) {
                    return markup;
                }
            });*/
        });
    </script>
    <script nonce="<%= nonce %>">
        document.getElementById('registrationForm').addEventListener('submit', function (event) {
            // Включаем все поля перед отправкой формы
            document.querySelectorAll('#commonFields input, #commonFields textarea').forEach(input => input.disabled = false);
            document.querySelectorAll('#candidateFields input, #candidateFields textarea').forEach(input => input.disabled = false);
            document.querySelectorAll('#employerFields input, #employerFields textarea').forEach(input => input.disabled = false);
        });
    </script>
    <script nonce="<%= nonce %>">
        // Функция для отправки запроса на регистрацию
        async function registerUser(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());

            // Обработка множественных значений чекбоксов
            const skills = formData.getAll('skills[]'); // Получаем все выбранные навыки
            data.skills = skills; // Добавляем массив навыков в данные

            try {
                const response = await fetch('/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    // Перенаправление на страницу профиля
                    window.location.href = '/profile.html';
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred during registration');
            }
        }

        // Привязка функции к форме регистрации
        document.getElementById('registrationForm').addEventListener('submit', registerUser);
    </script>
</body>

</html>